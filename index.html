<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø®Ø·ÙˆØ· Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª</title>

<style>
body{font-family:'Segoe UI',Arial;direction:rtl;margin:0;background:#f4f6f9}
header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;padding:15px;text-align:center;font-size:18px;font-weight:bold}
.container{padding:15px;max-width:900px;margin:auto}
.topBar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.roleBadge{padding:6px 12px;border-radius:20px;font-size:13px;font-weight:bold}
.adminBadge{background:#ffd700}
.repBadge{background:#d1ecf1}
input,button{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:1px solid #ccc;font-size:14px}
button{background:#1e3c72;color:white;border:none;cursor:pointer}
button:hover{opacity:0.9}
.searchBox{margin:10px 0}
.stats{display:flex;justify-content:space-between;margin:10px 0;font-size:14px}
.card{background:white;padding:15px;margin-top:10px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.08);transition:0.2s}
.card:hover{transform:scale(1.01)}
.renewed{border-right:6px solid #28a745}
.notRenewed{border-right:6px solid #dc3545}
.smallBtn{padding:6px 10px;font-size:12px;margin-top:8px;border-radius:6px}
.hidden{display:none}
</style>
</head>

<body>

<header>Ø¥Ø¯Ø§Ø±Ø© Ø®Ø·ÙˆØ· Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª</header>

<div class="container">

<!-- LOGIN -->
<div id="loginBox">
<input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
<input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

<div class="topBar">
  <div id="roleBadge" class="roleBadge"></div>
  <button id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<div class="searchBox">
  <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù…..." />
</div>

<div class="stats">
  <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…: <span id="countBox">0</span></div>
  <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="totalBox">0</span> Ø¬Ù†ÙŠÙ‡</div>
</div>

<div id="adminSection" class="hidden">
  <h3>Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù…</h3>
  <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
  <input type="text" id="family" placeholder="Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©">
  <input type="email" id="rep" placeholder="Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">
  <input type="number" id="price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
  <button id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
</div>

<div id="numbersList"></div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAmstcSyoxzo15KbXda8L8tn-03LclRwkQ",
  authDomain: "red-family.firebaseapp.com",
  projectId: "red-family",
  storageBucket: "red-family.firebasestorage.app",
  messagingSenderId: "1087910827923",
  appId: "1:1087910827923:web:6a681071ada3f5d921fa66"
};

const adminEmail = "omaradelmama5@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// LOGIN
document.getElementById("loginBtn").addEventListener("click", async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (err) {
    alert(err.message);
  }
});

// LOGOUT
document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth);
});

// ADD NUMBER (Admin)
document.getElementById("addBtn").addEventListener("click", async () => {
  const phone = document.getElementById("phone").value;
  const family = document.getElementById("family").value;
  const rep = document.getElementById("rep").value;
  const price = parseFloat(document.getElementById("price").value);

  if(!phone || !family || !rep){
    alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    return;
  }

  await addDoc(collection(db,"numbers"),{
    phone,family,rep,price,renewed:false
  });

  location.reload();
});

// AUTH STATE
onAuthStateChanged(auth, async (user) => {

  if(user){
    loginBox.classList.add("hidden");
    dashboard.classList.remove("hidden");

    const roleBadge = document.getElementById("roleBadge");

    let snapshot;

    if(user.email === adminEmail){
      roleBadge.innerText = "ğŸ‘‘ Admin";
      roleBadge.className = "roleBadge adminBadge";
      adminSection.classList.remove("hidden");
      snapshot = await getDocs(collection(db,"numbers"));
    }else{
      roleBadge.innerText = "ğŸ‘¤ Ù…Ù†Ø¯ÙˆØ¨";
      roleBadge.className = "roleBadge repBadge";
      const q = query(collection(db,"numbers"), where("rep","==",user.email));
      snapshot = await getDocs(q);
    }

    renderNumbers(snapshot,user);

  }else{
    loginBox.classList.remove("hidden");
    dashboard.classList.add("hidden");
  }
});

// RENDER
async function renderNumbers(snapshot,user){

  const numbersList = document.getElementById("numbersList");
  const searchValue = document.getElementById("searchInput").value || "";
  numbersList.innerHTML="";

  let count = 0;
  let total = 0;

  snapshot.forEach(d=>{
    const n = d.data();

    if(searchValue && !n.phone.includes(searchValue)) return;

    count++;
    total += n.price || 0;

    const card = document.createElement("div");
    card.className = "card " + (n.renewed ? "renewed" : "notRenewed");

    card.innerHTML = `
      <strong>${n.phone}</strong><br>
      ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©: ${n.family}<br>
      ğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${n.price} Ø¬Ù†ÙŠÙ‡<br>
      ğŸ”„ Ø§Ù„Ø­Ø§Ù„Ø©: ${n.renewed ? "Ù…ØªØ¬Ø¯Ø¯" : "ØºÙŠØ± Ù…ØªØ¬Ø¯Ø¯"}
    `;

    if(user.email === adminEmail){
      const btn = document.createElement("button");
      btn.className="smallBtn";
      btn.innerText="ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯";
      btn.onclick = async ()=>{
        await updateDoc(doc(db,"numbers",d.id),{
          renewed: !n.renewed
        });
        location.reload();
      };
      card.appendChild(btn);
    }

    numbersList.appendChild(card);
  });

  document.getElementById("countBox").innerText = count;
  document.getElementById("totalBox").innerText = total;
}

// SEARCH
document.getElementById("searchInput").addEventListener("input", ()=>{
  location.reload();
});

</script>

</body>
</html>