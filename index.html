<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام إدارة الخطوط</title>
<style>
body{
    font-family: Arial;
    direction: rtl;
    margin:0;
    background:#f2f4f8;
}
header{
    background:#1e3c72;
    color:white;
    padding:15px;
    text-align:center;
    font-size:20px;
}
.container{ padding:15px; }
input,select,button{
    width:100%;
    padding:12px;
    margin:6px 0;
    border-radius:8px;
    border:1px solid #ccc;
}
button{
    background:#1e3c72;
    color:white;
    border:none;
}
.card{
    background:white;
    padding:12px;
    margin-top:10px;
    border-radius:10px;
}
.hidden{ display:none; }
.adminOnly{ display:none; }
</style>
</head>
<body>

<header>إدارة خطوط العائلات</header>

<div class="container">

<div id="loginBox">
<input type="email" id="email" placeholder="البريد الإلكتروني">
<input type="password" id="password" placeholder="كلمة المرور">
<button onclick="login()">تسجيل دخول</button>
</div>

<div id="dashboard" class="hidden">

<button onclick="logout()">تسجيل خروج</button>

<div id="adminSection" class="adminOnly">
<h3>إضافة رقم</h3>
<input type="text" id="phone" placeholder="رقم">
<input type="text" id="family" placeholder="العائلة">
<input type="text" id="rep" placeholder="المندوب">
<input type="number" id="price" placeholder="السعر">
<button onclick="addNumber()">إضافة</button>
</div>

<div id="numbersList"></div>

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAmstcSyoxzo15KbXda8L8tn-03LclRwkQ",
  authDomain: "red-family.firebaseapp.com",
  projectId: "red-family",
  storageBucket: "red-family.firebasestorage.app",
  messagingSenderId: "1087910827923",
  appId: "1:1087910827923:web:6a681071ada3f5d921fa66",
  measurementId: "G-L3Z2Q2ZY12"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const adminEmail = "omaraadlemam5@gmail.com";

window.login = function(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  signInWithEmailAndPassword(auth, email, password)
  .catch(err => alert(err.message));
}

window.logout = function(){
  signOut(auth);
}

onAuthStateChanged(auth, user => {
  if(user){
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    if(user.email === adminEmail){
        document.getElementById("adminSection").style.display="block";
        loadNumbers();
    }else{
        loadNumbers(user.email);
    }
  }else{
    document.getElementById("loginBox").classList.remove("hidden");
    document.getElementById("dashboard").classList.add("hidden");
  }
});

async function addNumber(){
  await addDoc(collection(db,"numbers"),{
    phone: phone.value,
    family: family.value,
    rep: rep.value,
    price: parseFloat(price.value),
    renewed:false
  });
  alert("تمت الإضافة");
  loadNumbers();
}

async function loadNumbers(repEmail=null){
  const list = document.getElementById("numbersList");
  list.innerHTML="";
  let q;
  if(repEmail){
    q = query(collection(db,"numbers"), where("rep","==",repEmail));
  }else{
    q = collection(db,"numbers");
  }
  const snapshot = await getDocs(q);
  snapshot.forEach(doc=>{
    const n = doc.data();
    list.innerHTML += `
      <div class="card">
        <strong>${n.phone}</strong><br>
        العائلة: ${n.family}<br>
        السعر: ${n.price}<br>
        الحالة: ${n.renewed ? "متجدد ✅" : "غير متجدد ❌"}
      </div>
    `;
  });
}

</script>

</body>
</html>