<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø·ÙˆØ·</title>

<style>
body{font-family:'Segoe UI';direction:rtl;margin:0;background:#f4f6f9}
header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;padding:15px;text-align:center;font-size:18px;font-weight:bold}
.container{max-width:1000px;margin:auto;padding:15px}
.hidden{display:none}
input,select,button{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:1px solid #ccc}
button{background:#1e3c72;color:white;border:none;cursor:pointer}
button:hover{opacity:0.9}
.card{background:#fff;padding:15px;margin-top:10px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,0.1)}
.renewed{border-right:5px solid #28a745}
.notRenewed{border-right:5px solid #dc3545}
.topbar{display:flex;justify-content:space-between;align-items:center}
.badge{padding:6px 12px;border-radius:20px;font-size:13px;font-weight:bold}
.admin{background:#ffd700}
.rep{background:#d1ecf1}
.section{background:white;padding:15px;border-radius:12px;margin-top:15px}
.stats{display:flex;justify-content:space-between;margin-top:10px;font-size:14px}
</style>
</head>

<body>

<header>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø·ÙˆØ·</header>

<div class="container">

<!-- LOGIN -->
<div id="loginBox">
<input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
<input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

<div class="topbar">
<div id="roleBadge" class="badge"></div>
<button id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<div class="stats">
<div>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…: <span id="countBox">0</span></div>
<div id="totalStat">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="totalBox">0</span> Ø¬Ù†ÙŠÙ‡</div>
</div>

<!-- ADMIN FAMILY MANAGEMENT -->
<div id="familySection" class="section hidden">
<h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª</h3>
<input type="text" id="newFamily" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©">
<button id="addFamilyBtn">Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ø¦Ù„Ø©</button>

<select id="familyFilter">
<option value="">ÙƒÙ„ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª</option>
</select>

<div id="familyList"></div>
</div>

<!-- ADMIN ADD NUMBER -->
<div id="addSection" class="section hidden">
<h3>Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù…</h3>
<input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
<select id="familySelect"></select>
<input type="email" id="rep" placeholder="Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">
<input type="number" id="price" placeholder="Ø§Ù„Ø³Ø¹Ø±">
<button id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
</div>

<input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù…...">

<div id="numbersList"></div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAmstcSyoxzo15KbXda8L8tn-03LclRwkQ",
  authDomain: "red-family.firebaseapp.com",
  projectId: "red-family",
  storageBucket: "red-family.firebasestorage.app",
  messagingSenderId: "1087910827923",
  appId: "1:1087910827923:web:6a681071ada3f5d921fa66"
};

const adminEmail = "omaraadlemam5@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

loginBtn.onclick = async ()=>{
const email=email.value;
const password=password.value;
await signInWithEmailAndPassword(auth,email,password).catch(e=>alert(e.message));
};

logoutBtn.onclick=()=>signOut(auth);

// AUTH STATE
onAuthStateChanged(auth, async (user)=>{

if(!user){
loginBox.classList.remove("hidden");
dashboard.classList.add("hidden");
return;
}

loginBox.classList.add("hidden");
dashboard.classList.remove("hidden");

if(user.email===adminEmail){
roleBadge.innerText="ğŸ‘‘ Admin";
roleBadge.className="badge admin";
familySection.classList.remove("hidden");
addSection.classList.remove("hidden");
totalStat.style.display="block";
await loadFamilies();
}else{
roleBadge.innerText="ğŸ‘¤ Ù…Ù†Ø¯ÙˆØ¨";
roleBadge.className="badge rep";
totalStat.style.display="none";
}

loadNumbers(user);
});

// LOAD FAMILIES
async function loadFamilies(){
const snap=await getDocs(collection(db,"families"));
familyFilter.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª</option>';
familySelect.innerHTML='';
familyList.innerHTML='';

snap.forEach(d=>{
const f=d.data().name;
familyFilter.innerHTML+=`<option value="${f}">${f}</option>`;
familySelect.innerHTML+=`<option value="${f}">${f}</option>`;

const div=document.createElement("div");
div.innerHTML=`${f} <button onclick="deleteFamily('${d.id}')">Ø­Ø°Ù</button>`;
familyList.appendChild(div);
});
}

window.deleteFamily=async(id)=>{
await deleteDoc(doc(db,"families",id));
loadFamilies();
};

addFamilyBtn.onclick=async()=>{
if(!newFamily.value)return;
await addDoc(collection(db,"families"),{name:newFamily.value});
newFamily.value="";
loadFamilies();
};

addBtn.onclick=async()=>{
await addDoc(collection(db,"numbers"),{
phone:phone.value,
family:familySelect.value,
rep:rep.value,
price:parseFloat(price.value),
renewed:false
});
location.reload();
};

// LOAD NUMBERS
async function loadNumbers(user){

let snap;

if(user.email===adminEmail){
snap=await getDocs(collection(db,"numbers"));
}else{
const q=query(collection(db,"numbers"),where("rep","==",user.email));
snap=await getDocs(q);
}

renderNumbers(snap,user);
}

function renderNumbers(snap,user){

numbersList.innerHTML="";
let count=0;
let total=0;

snap.forEach(d=>{
const n=d.data();

if(searchInput.value && !n.phone.includes(searchInput.value))return;
if(familyFilter.value && n.family!==familyFilter.value)return;

count++;
total+=n.price||0;

const card=document.createElement("div");
card.className="card "+(n.renewed?"renewed":"notRenewed");

if(user.email===adminEmail){
card.innerHTML=`
<strong>${n.phone}</strong><br>
ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ${n.family}<br>
ğŸ’° ${n.price} Ø¬Ù†ÙŠÙ‡<br>
ğŸ”„ ${n.renewed?"Ù…ØªØ¬Ø¯Ø¯":"ØºÙŠØ± Ù…ØªØ¬Ø¯Ø¯"}
<button onclick="toggleRenew('${d.id}',${n.renewed})">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</button>
`;
}else{
card.innerHTML=`
<strong>${n.phone}</strong><br>
ğŸ”„ ${n.renewed?"Ù…ØªØ¬Ø¯Ø¯ âœ…":"ØºÙŠØ± Ù…ØªØ¬Ø¯Ø¯ âŒ"}
`;
}

numbersList.appendChild(card);
});

countBox.innerText=count;
totalBox.innerText=total;
}

window.toggleRenew=async(id,state)=>{
await updateDoc(doc(db,"numbers",id),{renewed:!state});
location.reload();
};

searchInput.oninput=()=>location.reload();
familyFilter.onchange=()=>location.reload();

</script>
</body>
</html>
